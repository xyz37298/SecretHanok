<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš°ë¦¬ë™ë„¤ ë¹„ë°€ì˜ í•œì˜¥</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sunflower:wght@300&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>

    <style>
        *{
            font-family: "Sunflower", serif;
            font-weight: 700;
            font-style: normal;
            cursor:url('static/images/cursor.png')2 2, auto;
        }
        body {
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /*ì™¼ìª½ ì •ë ¬*/
            align-items: flex-start; /*ì™¼ìª½ ì •ë ¬*/
            height: 100vh;
            background-color: #ffffff;
            margin: 0;
        }
        .container {
            display: flex;
            height: 100%;
            gap: 20px;
            padding: 40px;
        }
        .right-container{
            width: 440px;
        }
        .header {
            width: 100%;
            height: 200px;
            background-color:#ffffff;
        }
        .video-container {
            position: relative;
            width: 440px;
            align-items: flex-start;
            /* padding: 12px; */
        }
        video {
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
            border-radius: 16px;
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            transform: scaleX(1);
        }
        .gesture-info {
            display: flex;
            flex-direction: column;
            text-align: center;
            font-weight: bold;
            width: 1600px;
        }
        .info-container {
            display: grid;
            width: 95%;
            text-align: left;
            font-size: 18px;
            line-height: 30px;
            color: black;
            padding: 14px;
        }
        .artist-info{
            display: flex;
            flex-direction: column;
            background-color:rgba(145,226,193,0.6);
            border-radius:16px;
            text-align: left;
            font-weight: bold;
            line-height:40px;
            width: 300px;
            height:90%;
            padding:50px;
        }
        .menu-container {
            display: grid;
            text-align: center;
            background-color: white;
            margin-top:10px;
        }
        .menu-button {
            width: 420px;
            height: 70px;
            border: none;
            background-color: transparent;
            color: black;
            font-size: 40px;
            font-weight: 700;
            cursor: pointer;
            text-align: left;
            display: flex; align-items: center;
            border-top: 4px solid black;  /* ìœ„ í…Œë‘ë¦¬ */
        }
        .menu-button:hover {
            background-color: #FFF292; /* í˜¸ë²„ ì‹œ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë³€ê²½ */
            cursor:url('static/images/cursor.png')2 2, auto;
        }
        #gesture-image {
            width: 100%;
            height: 900px;
            object-fit: cover;
            align-items: flex-start;
            background-color: white;
            border-radius: 16px;
        }
        #gesture-result {
            text-align: center;
            font-size: 24px;
            color: black;
        }
        #gesture-subtitle {
            font-size: 32px;
            width: 100%;
            font-weight: bold;
            line-height: 55px;
            color: black;
            text-align: center;
            margin-top: 20px;
        }
        #header-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>

<body>
    <header class="header">
        <img id="header-image" src="static/images/header.png">
    </header>
    <div class="container">
        <!-- ğŸ“Œ ì™¼ìª½: ì›¹ìº ê³¼ ë©”ë‰´ -->
        <div class="right-container">
            <div class="video-container">
                <video id="video" autoplay></video>
                <canvas id="canvas"></canvas>
            </div>
            <div class="info-container">
                2024ë…„ 5060 ìœµë³µí•© ì°½ì‘ & ì‰¼ í”„ë¡œì íŠ¸ 'ìš°ë¦¬ë™ë„¤ ë¹„ë°€ì˜ í•œì˜¥'ì— ëª¨ì¸ ì°¸ì—¬ìë“¤ì€ ë™ì‘ì„ ì¸ì‹í•˜ëŠ”
                ì¸ê³µì§€ëŠ¥ì— ëŒ€í•´ ì•Œì•„ë³´ê³ , ë‚˜ì˜ ì†ì— ë‹´ê¸´ ì´ì•¼ê¸°ë¥¼ êº¼ë‚´ ì¸í„°ë ‰í‹°ë¸Œ ì‘í’ˆì„ ì°½ì‘í–ˆìŠµë‹ˆë‹¤. í™”ë©´ì— ì†ì„ ë¹„ì¶° ì›í•˜ëŠ” ì´ì•¼ê¸°ë¥¼ ë“¤ì–´ë³´ì„¸ìš”!
            </div>
            <div class="menu-container">
                <button class="menu-button">ë¯¼ë³„</button>
                <button class="menu-button">ë°±ì¤€ê¸°</button>
                <button class="menu-button">ì–‘ìˆœì—´</button>
                <button class="menu-button">ìœ ë¦¼</button>
                <button class="menu-button">ìœ¤í¬ì •</button>
                <button class="menu-button">ì£¼ì€í¬</button>
                <button class="menu-button">í•˜ì¬êµ¬</button>
                <button class="menu-button" style="border-bottom: 4px solid black;">í—ˆë‚˜ìœ¤</button>
                <img style="margin-top:50px;" src="static/images/logo.png">
            </div>
        </div>

        <!-- ğŸ“Œ ì˜¤ë¥¸ìª½: ì œìŠ¤ì²˜ ì •ë³´ -->
        <div class="gesture-info">
                <img id="gesture-image" src="" alt="ì œìŠ¤ì²˜ ì´ë¯¸ì§€">
                <p id="gesture-subtitle"></p>
                <p id="gesture-result"></p>
        </div>

        <div class="artist-info">
            <p style="font-size: 30px;">í†µì¦ê³¼ í•¨ê»˜ í•˜ëŠ” ì‚¶</p>
            <p style="font-size: 22px;">
                <span style = "background-color: #FFF292;">ã†ë§Œë“  ì´</span> <br>
                <span>ì„¸ìƒì— ë¬´í•´í•œ ì¡´ì¬ê°€ ë˜ê¸¸ <br>ë°”ë¼ëŠ” ì‚¬ëŒ</span><br><br>
                <span style = "background-color: #FFF292;">ã†ì‘í’ˆì„ í†µí•´ ì „ë‹¬ë˜ì—ˆìœ¼ë©´ <br> í•˜ëŠ” ë©”ì„¸ì§€ê°€ ìˆë‹¤ë©´?</span> <br>
                ë¶ˆí˜„ë“¯ ì°¾ì•„ì˜¨ í†µì¦ì´ <br>ì‚¶ì„ ì§€ë°°í•œë‹¤ë©´<br><br>
                <span style = "background-color: #FFF292;">ã†í•œë§ˆë””</span> <br>
                ì´ë¥¼ ì•…ë¬¼ê³  ì†ì„ ê½‰ ì¥ì§€ ë§ê³ <br> ë¦´ë ‰ìŠ¤, ê·¸ë˜ì•¼ ê¸¸ê²Œ ì‚´ì•„ì§„ë‹¤ 
            </p>
        </div>
    </div>  

    <script>
        const socket = io.connect("https://secrethanok.onrender.com/", {
            transports: ['websocket', 'polling'],
            upgrade: true,
            reconnection: true,
            timeout: 20000
        });
        let isPlaying = false;  // ìŒì„± ì¬ìƒ ì—¬ë¶€ í™•ì¸
        let lastGestureData = null;

        function playAudio(audioSrc) {
            if (isPlaying) return; // ìŒì„±ì´ ì´ë¯¸ ì¬ìƒ ì¤‘ì´ë©´ ë¬´ì‹œ

            isPlaying = true;
            let audio = new Audio(audioSrc);
            audio.play();

            audio.onended = function() {
                isPlaying = false;  // ìŒì„±ì´ ëë‚˜ë©´ ë‹¤ì‹œ ê°ì§€ ì‹œì‘

                if(lastGestureData) {
                    updateUI(lastGestureData); //ìŒì„±ì´ ëë‚œ í›„ UI ì—…ë°ì´íŠ¸

                    if(lastGetureData.sound){
                        playAudio(lastGestureData.sound); //ìƒˆë¡œìš´ ì†ë™ì‘ì´ ìˆë‹¤ë©´ ìƒˆë¡œìš´ ìŒì„± ì¬ìƒ
                    }
                }
            };
        }

        function updateUI(data) {
            document.getElementById("gesture-result").textContent = `${data.gesture}`;
            document.getElementById("gesture-subtitle").innerHTML = data.subtitle;
            document.getElementById("gesture-image").src = data.image_url || "";
        }

        socket.on('gesture_result', function(data) {        
        if (!isPlaying) {
            updateUI(data);  // âœ… ìŒì„±ì´ ì¬ìƒ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ UI ì—…ë°ì´íŠ¸
            playAudio(data.sound); //ë°”ë¡œ ìŒì„± ì¬ìƒ
        }

        if (data.sound) {
            playAudio(data.sound);
        }
    });

        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");

        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
                console.log("ì›¹ìº  ìŠ¤íŠ¸ë¦¼ ì—°ê²° ì„±ê³µ");
            })
            .catch(err => {
                console.error("ì›¹ìº ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", err);
            });

        function sendFrame() {
            const tempCanvas = document.createElement("canvas");
            tempCanvas.width = video.videoWidth;
            tempCanvas.height = video.videoHeight;
            const tempCtx = tempCanvas.getContext("2d");
            tempCtx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);
            const imageData = tempCanvas.toDataURL("image/png");
            console.log("í”„ë ˆì„ ì „ì†¡ ì¤‘ ... ë°ì´í„° í¬ê¸°:", imageData.length);
            console.log("ë¹„ë””ì˜¤ ê°€ë¡œì„¸ë¡œ:", video.videoWidth, video.videoHeight);
            socket.emit("video_frame", imageData);
        }

        socket.on("hand_landmarks", (data) => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            ctx.save();
            ctx.translate(canvas.width, 0);
            ctx.scale(-1,1);

            data.landmarks.forEach(hand => {
                ctx.beginPath();
                hand.forEach((point, index) => {
                    const x = point.x * canvas.width;
                    const y = point.y * canvas.height;
                    ctx.fillStyle = "red";
                    ctx.beginPath();
                    ctx.arc(x, y, 5, 0, 2 * Math.PI);
                    ctx.fill();
                });
            });

            ctx.restore();
        });

        setInterval(sendFrame, 100);
    </script>
</body>
</html>
